/**
 * Script to populate TechRent Uzbekistan with comprehensive 12-block roadmap
 * Based on user's detailed plan for MAYDON ecosystem
 * Run with: node scripts/populate-full-roadmap.mjs
 */

import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

const DATABASE_URL = process.env.DATABASE_URL;
const url = new URL(DATABASE_URL);
const connection = await mysql.createConnection({
  host: url.hostname,
  port: parseInt(url.port) || 3306,
  user: url.username,
  password: url.password,
  database: url.pathname.slice(1),
  ssl: { rejectUnauthorized: false }
});

const PROJECT_ID = 1;

// Full roadmap structure based on user's plan
const roadmap = [
  {
    number: 1,
    title: "Исследование и анализ",
    description: "Маркетинговое исследование, Customer Development, анализ поставщиков",
    deadline: "2026-03-05", // 4 weeks from start
    duration: "4 недели",
    sections: [
      {
        title: "Маркетинговое исследование",
        tasks: [
          "Анализ рынка аренды спецтехники в Узбекистане (TAM, SAM, SOM)",
          "Оценка темпов роста рынка",
          "Сегментация: строительство, карьеры, склады, промышленность",
          "Анализ географии спроса (Ташкент, регионы)",
          "Исследование сезонности спроса",
          "Конкурентный анализ: mapping всех игроков",
          "Анализ парка техники, цен, качества сервиса конкурентов",
          "Выявление gaps на рынке",
          "Оценка барьеров входа",
          "Мониторинг тендеров на uzex.uz, e-auksion.uz, xarid.uz",
          "Анализ типовых объемов и условий контрактов",
          "Изучение требований к участникам тендеров",
          "Определение средних цен в тендерах"
        ]
      },
      {
        title: "Customer Development",
        tasks: [
          "Интервью со строительными компаниями (10 интервью)",
          "Интервью с ГМК и карьерами (5 интервью)",
          "Интервью со складами и логистическими центрами (5 интервью)",
          "Интервью с производственными предприятиями (5 интервью)",
          "Интервью с застройщиками (5 интервью)",
          "Выявление текущих pain points с арендой техники",
          "Определение приоритетов: цена vs сервис",
          "Оценка готовности к долгосрочным контрактам",
          "Выявление дефицитной техники на рынке",
          "Определение willingness to pay (готовность платить)"
        ]
      },
      {
        title: "Анализ поставщиков",
        tasks: [
          "Анализ поставщиков новой техники (XCMG, HOWO, Shacman, БелАЗ)",
          "Анализ рынка б/у техники (Россия, Китай, Европа)",
          "Сравнение цен и условий поставки",
          "Изучение возможностей лизинга техники",
          "Анализ лизинговых компаний (5-7 компаний)",
          "Сравнение условий лизинга: ставки, первый взнос, сроки",
          "Изучение требований к заемщику"
        ]
      }
    ]
  },
  {
    number: 2,
    title: "Стратегия и планирование",
    description: "Позиционирование, операционная модель, IT-системы",
    deadline: "2026-03-26", // 3 weeks after block 1
    duration: "3 недели",
    sections: [
      {
        title: "Позиционирование и стратегия",
        tasks: [
          "Определение целевых сегментов (приоритизация)",
          "Разработка УТП (Unique Value Proposition)",
          "Выбор стратегии роста: органический vs M&A vs франчайзинг",
          "Определение горизонтальной vs вертикальной экспансии",
          "Разработка pricing strategy (ценообразование)",
          "Создание go-to-market плана"
        ]
      },
      {
        title: "Операционная модель",
        tasks: [
          "Разработка организационной структуры",
          "Определение минимальной команды для старта",
          "Распределение ролей и ответственностей",
          "Разработка системы мотивации персонала",
          "Создание Customer journey map",
          "Описание операционных процессов (подача техники, обслуживание, ремонт)",
          "Разработка системы контроля качества",
          "Определение требований к базам (размер, оснащение)",
          "Планирование географии базирования (Ташкент + регионы)",
          "Разработка логистики доставки техники"
        ]
      },
      {
        title: "Технологии и IT",
        tasks: [
          "Выбор ERP для управления парком",
          "Выбор CRM для клиентов",
          "Выбор системы телематики (GPS-мониторинг)",
          "Планирование веб-сайта и онлайн-бронирования",
          "Планирование интеграции с 1С/IIKO",
          "Интеграция платежных систем (Payme, Click, Uzum)",
          "Разработка API для корпоративных клиентов"
        ]
      }
    ]
  },
  {
    number: 3,
    title: "Финансовое моделирование",
    description: "Детальная финмодель, расчет потребности в финансировании",
    deadline: "2026-04-09", // 2 weeks after block 2
    duration: "2 недели",
    sections: [
      {
        title: "CAPEX и OPEX",
        tasks: [
          "Расчет стартового парка техники",
          "Планирование поэтапного расширения (год 1-5)",
          "Расчет инфраструктуры (базы, IT, оборудование)",
          "Определение оборотного капитала",
          "Расчет ФОТ (зарплаты)",
          "Расчет расходов на топливо, ТО, ремонты",
          "Расчет аренды баз",
          "Бюджет на маркетинг",
          "Административные расходы"
        ]
      },
      {
        title: "Revenue Model и P&L",
        tasks: [
          "Прогноз загрузки парка (реалистичный)",
          "Разработка тарифов по типам техники",
          "Учет сезонности в прогнозах",
          "Прогноз роста выручки (year-over-year)",
          "Помесячный прогноз P&L на год 1",
          "Ежегодный прогноз на 5 лет",
          "Расчет валовой прибыли, EBITDA, чистой прибыли"
        ]
      },
      {
        title: "Cash Flow и метрики",
        tasks: [
          "Расчет операционного Cash Flow",
          "Расчет инвестиционного Cash Flow",
          "Расчет финансового CF (погашение лизинга/кредитов)",
          "Определение кэш-гэпов (когда нужны деньги)",
          "Расчет активов и пассивов",
          "Расчет ROI, ROE, ROIC",
          "Определение точки безубыточности",
          "Расчет срока окупаемости",
          "Разработка базового сценария",
          "Разработка оптимистичного сценария",
          "Разработка пессимистичного сценария",
          "Sensitivity analysis (загрузка -10%, цены -15%)"
        ]
      },
      {
        title: "Потребность в финансировании",
        tasks: [
          "Расчет требуемого капитала",
          "Определение собственных средств",
          "Планирование привлечения инвесторов (equity)",
          "Планирование лизинга",
          "Планирование банковских кредитов",
          "Определение доли в компании для инвесторов",
          "Оценка компании (valuation)",
          "Разработка exit стратегии",
          "Определение прав и защиты инвесторов"
        ]
      }
    ]
  },
  {
    number: 4,
    title: "Pitch Deck и бизнес-план",
    description: "Подготовка материалов для инвесторов",
    deadline: "2026-04-23", // 2 weeks after block 3
    duration: "2 недели",
    sections: [
      {
        title: "Pitch Deck (12-15 слайдов)",
        tasks: [
          "Слайд 1: Обложка (название, слоган, контакты)",
          "Слайд 2: Problem (какую проблему решаем)",
          "Слайд 3: Solution (наше решение)",
          "Слайд 4: Market Opportunity (размер рынка, рост)",
          "Слайд 5: Business Model (как зарабатываем)",
          "Слайд 6: Product/Services (портфель техники и услуг)",
          "Слайд 7: Traction (пилоты, предзаказы, LOI)",
          "Слайд 8: Competitive Advantage (чем отличаемся)",
          "Слайд 9: Go-to-Market Strategy",
          "Слайд 10: Team (команда, опыт с HELI/VendHub)",
          "Слайд 11: Financials (ключевые метрики на 5 лет)",
          "Слайд 12: Funding Ask (сколько нужно, на что, условия)",
          "Слайд 13: Roadmap (план развития)",
          "Слайд 14: Vision (долгосрочная перспектива + MAYDON)",
          "Слайд 15: Contact & Q&A"
        ]
      },
      {
        title: "Полный бизнес-план (30-50 страниц)",
        tasks: [
          "Executive Summary (2-3 стр)",
          "Описание компании и продукта (5 стр)",
          "Анализ рынка и конкурентов (10 стр)",
          "Маркетинг и продажи (5 стр)",
          "Операционный план (5 стр)",
          "Команда (3 стр)",
          "Финансовый план (10 стр)",
          "Риски и митигация (3 стр)",
          "Приложения (финмодель, исследования)"
        ]
      }
    ]
  },
  {
    number: 5,
    title: "Юридическая структура",
    description: "Регистрация, лицензии, договорная база, страхование",
    deadline: "2026-05-21", // 4 weeks, runs in parallel
    duration: "4 недели",
    sections: [
      {
        title: "Регистрация компании",
        tasks: [
          "Выбор организационно-правовой формы (ООО vs филиал GLOBERENT)",
          "Определение размера уставного капитала",
          "Регистрация в налоговой",
          "Открытие расчетного счета",
          "Изготовление печатей, доверенностей"
        ]
      },
      {
        title: "Лицензии и разрешения",
        tasks: [
          "Составление перечня необходимых лицензий",
          "Получение лицензии для карьерных работ (если требуется)",
          "Вступление в СРО (если требуется)",
          "Сертификация техники",
          "Получение экологических разрешений"
        ]
      },
      {
        title: "Договорная база",
        tasks: [
          "Разработка типового договора аренды с экипажем",
          "Разработка типового договора аренды без экипажа",
          "Разработка договора долгосрочной аренды",
          "Создание актов приема-передачи",
          "Разработка договоров с поставщиками",
          "Разработка договоров с подрядчиками (логистика, сервис)",
          "Создание шаблонов трудовых договоров"
        ]
      },
      {
        title: "Страхование",
        tasks: [
          "Оформление КАСКО на технику",
          "Страхование ответственности",
          "Страхование персонала"
        ]
      }
    ]
  },
  {
    number: 6,
    title: "Привлечение финансирования",
    description: "Питчинг инвесторам, банковское финансирование",
    deadline: "2026-07-23", // 2-3 months
    duration: "2-3 месяца",
    sections: [
      {
        title: "Подготовка к питчингу",
        tasks: [
          "Составление списка angel investors в Узбекистане",
          "Поиск VC фондов (региональные и международные)",
          "Определение strategic investors (крупные rental компании)",
          "Подготовка заявок в банки (кредиты под залог)",
          "Контакты с лизинговыми компаниями",
          "Финализация Pitch Deck",
          "Подготовка One-pager",
          "Подготовка Detailed financials",
          "Подготовка к Due diligence"
        ]
      },
      {
        title: "Питчинг и переговоры",
        tasks: [
          "Warm intro через сеть (поиск связей)",
          "Холодный outreach к инвесторам",
          "Проведение питч-сессий (10-20 встреч)",
          "Follow-up и negotiations",
          "Согласование Term sheet",
          "Прохождение Due diligence",
          "Signing и закрытие раунда"
        ]
      },
      {
        title: "Банковское финансирование",
        tasks: [
          "Подача кредитных заявок (5-7 банков)",
          "Подготовка залогов",
          "Переговоры по ставкам",
          "Закрытие кредитных линий"
        ]
      }
    ]
  },
  {
    number: 7,
    title: "Запуск операций",
    description: "Инфраструктура, закупка техники, персонал, IT-системы",
    deadline: "2026-10-23", // 2-3 months after financing
    duration: "2-3 месяца",
    sections: [
      {
        title: "Инфраструктура",
        tasks: [
          "Поиск и аренда базы в Ташкенте",
          "Переговоры с арендодателем",
          "Заключение договора аренды",
          "Установка навесов для техники",
          "Оборудование мастерской (инструменты)",
          "Организация склада запчастей",
          "Установка мойки",
          "Договор с АЗС или топливная станция",
          "Обустройство офиса (мебель, оборудование)",
          "Установка бытовок для персонала",
          "Организация охраны и видеонаблюдения"
        ]
      },
      {
        title: "Закупка техники",
        tasks: [
          "Финализация списка стартового парка",
          "Переговоры с поставщиками",
          "Оформление лизинга (если применимо)",
          "Заказ и импорт техники",
          "Таможенное оформление",
          "Сертификация техники",
          "Страхование КАСКО",
          "Установка GPS-трекеров",
          "Брендирование (покраска в корпоративные цвета)"
        ]
      },
      {
        title: "Персонал",
        tasks: [
          "Найм технического директора (CTO)",
          "Найм коммерческого директора (CCO)",
          "Найм главного механика",
          "Найм начальника диспетчерской",
          "Найм менеджеров продаж (3-5 чел)",
          "Найм водителей/операторов (20-30 чел)",
          "Найм механиков (3-5 чел)",
          "Найм диспетчеров (2-3 чел)",
          "Найм бухгалтера",
          "Вводный инструктаж для персонала",
          "Обучение безопасности",
          "Обучение работе с IT-системами",
          "Внедрение корпоративной культуры"
        ]
      },
      {
        title: "IT-системы",
        tasks: [
          "Внедрение ERP: настройка модулей",
          "Импорт данных в ERP",
          "Обучение персонала работе с ERP",
          "Запуск CRM",
          "Настройка телематики (GPS)",
          "Разработка дизайна сайта",
          "Создание каталога техники с фото",
          "Реализация онлайн-бронирования",
          "Создание личного кабинета клиента",
          "Интеграция платежей на сайте",
          "Тестирование всех IT-систем"
        ]
      }
    ]
  },
  {
    number: 8,
    title: "Маркетинг и продажи",
    description: "Брендинг, digital маркетинг, B2B продажи, тендеры, PR",
    deadline: "2026-11-23", // Start 1 month before launch
    duration: "1 месяц до запуска",
    sections: [
      {
        title: "Брендинг",
        tasks: [
          "Финализация названия компании",
          "Разработка логотипа",
          "Определение цветовой палитры",
          "Выбор шрифтов",
          "Создание Brand guidelines",
          "Создание презентации компании",
          "Разработка шаблона коммерческого предложения",
          "Создание каталога техники",
          "Заказ визиток",
          "Заказ брендированной одежды для персонала"
        ]
      },
      {
        title: "Digital маркетинг",
        tasks: [
          "SEO-оптимизация сайта",
          "Настройка контекстной рекламы (Google, Яндекс)",
          "Создание Instagram аккаунта",
          "Создание Facebook страницы",
          "Создание LinkedIn профиля",
          "Создание Telegram-канала",
          "Формирование базы контактов для email-маркетинга",
          "Запуск email-рассылок"
        ]
      },
      {
        title: "B2B продажи",
        tasks: [
          "Формирование базы строительных компаний (100+)",
          "Формирование базы застройщиков (50+)",
          "Формирование базы производственных предприятий (50+)",
          "Формирование базы складов и логистических центров (30+)",
          "Холодные звонки и outreach",
          "Личные встречи с ЛПР",
          "Переговоры и закрытие первых сделок",
          "Настройка CRM-воронки"
        ]
      },
      {
        title: "Тендеры",
        tasks: [
          "Подписка на тендерные площадки",
          "Мониторинг релевантных тендеров",
          "Подготовка документов для участия",
          "Подача заявок (цель: 5-10 в первый месяц)"
        ]
      },
      {
        title: "PR и партнерства",
        tasks: [
          "Подготовка пресс-релиза о запуске",
          "Публикации в отраслевых СМИ",
          "Участие в выставках (UzBuild, Mining World)",
          "Партнерства с производителями техники",
          "Партнерства со строительными ассоциациями",
          "Кросс-продажи с GLOBERENT/HELI"
        ]
      }
    ]
  },
  {
    number: 9,
    title: "Первые 100 дней работы",
    description: "Запуск, первые клиенты, операционная оптимизация",
    deadline: "2027-01-31", // 100 days after launch
    duration: "100 дней",
    sections: [
      {
        title: "Запуск и первые клиенты",
        tasks: [
          "Soft launch: привлечение 5-10 пилотных клиентов",
          "Отработка операционных процессов",
          "Сбор обратной связи от пилотных клиентов",
          "Official launch: PR-кампания",
          "Launch event (опционально)",
          "Закрытие первых 20-30 контрактов",
          "Выход на загрузку 30-40% в месяц 1-2",
          "Достижение загрузки 50-60% к месяцу 3"
        ]
      },
      {
        title: "Операционная оптимизация",
        tasks: [
          "Мониторинг загрузки техники",
          "Мониторинг времени простоя на ремонт",
          "Измерение Customer satisfaction (NPS)",
          "Отслеживание финансовых метрик",
          "Усиление того, что работает",
          "Изменение того, что не работает",
          "Проведение weekly team meetings"
        ]
      },
      {
        title: "Customer Success",
        tasks: [
          "Onboarding первых клиентов",
          "Регулярная коммуникация с клиентами",
          "Upsell и cross-sell",
          "Сбор отзывов и кейсов"
        ]
      }
    ]
  },
  {
    number: 10,
    title: "Масштабирование",
    description: "Расширение парка, географическая экспансия, новые направления",
    deadline: "2027-10-23", // Months 4-12
    duration: "месяцы 4-12",
    sections: [
      {
        title: "Расширение парка",
        tasks: [
          "Анализ спроса: какой техники не хватает",
          "Закупка дополнительной техники",
          "Цель: удвоение парка к концу года 1"
        ]
      },
      {
        title: "Географическая экспансия",
        tasks: [
          "Открытие базы в регионе (Навои или Алмалык)",
          "Найм локальной команды",
          "Локальный маркетинг в регионах"
        ]
      },
      {
        title: "Новые направления",
        tasks: [
          "Добавление новых типов техники",
          "Запуск новых услуг (обучение операторов, консалтинг)"
        ]
      },
      {
        title: "Финансовое управление",
        tasks: [
          "Достижение breakeven (месяц 6-7)",
          "Выход на плановую прибыль",
          "Реинвестирование прибыли",
          "Подготовка к Series A (если планируется)"
        ]
      }
    ]
  },
  {
    number: 11,
    title: "Связь с экосистемой MAYDON",
    description: "Интеграция с VendHub, GLOBERENT/HELI, будущие продукты",
    deadline: "2027-12-31", // Ongoing
    duration: "Постоянно",
    sections: [
      {
        title: "Концепция MAYDON",
        tasks: [
          "Описание экосистемы MAYDON: продукты и сервисы",
          "Определение целевой аудитории экосистемы",
          "Выявление синергий между продуктами",
          "Позиционирование TechRent в экосистеме",
          "Определение cross-sell возможностей"
        ]
      },
      {
        title: "Интеграция с VendHub",
        tasks: [
          "VendHub предоставляет кофе на объектах",
          "TechRent предоставляет технику строителям",
          "Синергия: комплексное обслуживание стройплощадок",
          "Единая платформа для заказа (кофе + техника)"
        ]
      },
      {
        title: "Интеграция с GLOBERENT/HELI",
        tasks: [
          "HELI продает технику → TechRent доставляет на тралах",
          "Клиенты HELI → потенциальные клиенты TechRent",
          "Общий сервисный центр",
          "Trade-in программа (сдача старой техники HELI → аренда у TechRent)"
        ]
      },
      {
        title: "Будущие продукты экосистемы",
        tasks: [
          "MAYDON Fintech: лизинг и финансирование для клиентов",
          "MAYDON Logistics: общая логистическая платформа",
          "MAYDON Marketplace: B2B платформа для стройматериалов + техника",
          "Единая экосистема для строительной отрасли Узбекистана"
        ]
      },
      {
        title: "Unified Platform",
        tasks: [
          "Единый личный кабинет для всех сервисов MAYDON",
          "Единая система лояльности",
          "Кросс-продажи и upsell",
          "Data sharing (клиентские данные между сервисами)"
        ]
      }
    ]
  },
  {
    number: 12,
    title: "Долгосрочная стратегия",
    description: "Годы 2-5: консолидация, доминирование, региональная экспансия",
    deadline: "2031-02-05", // 5 years
    duration: "годы 2-5",
    sections: [
      {
        title: "Год 2: Консолидация",
        tasks: [
          "Укрепление позиций в Ташкенте",
          "Выигрыш первых крупных тендеров",
          "Расширение в 2-3 региона",
          "Достижение $5-6 млн выручки"
        ]
      },
      {
        title: "Год 3: Доминирование",
        tasks: [
          "Топ-3 игрок на рынке Узбекистана",
          "Парк 100+ единиц техники",
          "Первые M&A (покупка мелких конкурентов)",
          "Выручка $8-10 млн"
        ]
      },
      {
        title: "Год 4-5: Региональная экспансия",
        tasks: [
          "Выход в соседние страны (Казахстан, Кыргызстан)",
          "Франчайзинг модель",
          "IPO или продажа стратегу (exit)",
          "Выручка $15-20 млн"
        ]
      },
      {
        title: "MAYDON как холдинг",
        tasks: [
          "TechRent = одна из компаний холдинга",
          "VendHub = другая компания",
          "GLOBERENT/HELI = третья",
          "MAYDON Fintech, Logistics и т.д.",
          "Единый бренд, единая экосистема",
          "Видение: Alibaba для строительной отрасли Узбекистана"
        ]
      }
    ]
  }
];

async function main() {
  console.log('=== Populating TechRent with comprehensive 12-block roadmap ===\n');
  
  // Update project info
  await connection.execute(
    `UPDATE projects SET 
      name = ?, 
      description = ?,
      startDate = ?,
      targetDate = ?
    WHERE id = ?`,
    [
      'TechRent Uzbekistan → MAYDON',
      'Крупнейшая диверсифицированная компания по аренде спецтехники полного спектра в Узбекистане с последующей интеграцией в экосистему MAYDON',
      '2026-02-05',
      '2031-02-05',
      PROJECT_ID
    ]
  );
  console.log('✓ Project info updated\n');
  
  // Delete existing data
  console.log('Clearing existing data...');
  await connection.execute(`DELETE FROM subtasks WHERE taskId IN (SELECT id FROM tasks WHERE sectionId IN (SELECT id FROM sections WHERE blockId IN (SELECT id FROM blocks WHERE projectId = ?)))`, [PROJECT_ID]);
  await connection.execute(`DELETE FROM tasks WHERE sectionId IN (SELECT id FROM sections WHERE blockId IN (SELECT id FROM blocks WHERE projectId = ?))`, [PROJECT_ID]);
  await connection.execute(`DELETE FROM sections WHERE blockId IN (SELECT id FROM blocks WHERE projectId = ?)`, [PROJECT_ID]);
  await connection.execute(`DELETE FROM blocks WHERE projectId = ?`, [PROJECT_ID]);
  console.log('✓ Existing data cleared\n');
  
  // Insert blocks, sections, and tasks
  let totalTasks = 0;
  let totalSections = 0;
  
  for (const block of roadmap) {
    // Insert block
    const [blockResult] = await connection.execute(
      `INSERT INTO blocks (projectId, number, title, description, deadline, duration, createdAt, updatedAt)
       VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())`,
      [PROJECT_ID, block.number, block.title, block.description, block.deadline, block.duration]
    );
    const blockId = blockResult.insertId;
    console.log(`Block ${block.number}: ${block.title}`);
    
    let sectionOrder = 0;
    for (const section of block.sections) {
      // Insert section
      const [sectionResult] = await connection.execute(
        `INSERT INTO sections (blockId, title, sortOrder, createdAt, updatedAt)
         VALUES (?, ?, ?, NOW(), NOW())`,
        [blockId, section.title, sectionOrder++]
      );
      const sectionId = sectionResult.insertId;
      totalSections++;
      console.log(`  Section: ${section.title} (${section.tasks.length} tasks)`);
      
      let taskOrder = 0;
      for (const taskTitle of section.tasks) {
        // Insert task
        await connection.execute(
          `INSERT INTO tasks (sectionId, title, status, sortOrder, createdAt, updatedAt)
           VALUES (?, ?, 'not_started', ?, NOW(), NOW())`,
          [sectionId, taskTitle, taskOrder++]
        );
        totalTasks++;
      }
    }
    console.log('');
  }
  
  console.log('=== Summary ===');
  console.log(`Total blocks: ${roadmap.length}`);
  console.log(`Total sections: ${totalSections}`);
  console.log(`Total tasks: ${totalTasks}`);
  console.log('\n✅ Roadmap populated successfully!');
  
  await connection.end();
}

main().catch(console.error);
